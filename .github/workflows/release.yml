name: Build and Release

on:
  push:
    tags:
      - '**'

jobs:
  run-script-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install font
        run: |
          sudo apt-get install -y --no-install-recommends fontconfig

          # Add Source Sans Pro font
          # Adpated from https://gist.github.com/jacksonpradolima/840b4a20c617204a65b15da61e124bf6
          # The RUN <<EOF set -e ... EOF has the effect of chaining all the commands together, so that if one fails, the whole RUN
          # command fails, but only one layer is created.
          set -e
          
          cd $(mktemp -d)
          TEMP_DIR=$(pwd)
          
          wget https://github.com/adobe-fonts/source-sans-pro/archive/2.020R-ro/1.075R-it.zip
          unzip 1.075R-it.zip
          sudo cp source-sans-2.020R-ro-1.075R-it/OTF/*.otf /usr/local/share/fonts
          
          sudo fc-cache -f -v
          rm -rf $TEMP_DIR
      

      # Install typst to allow for the generation of the PDFs outputs
      - uses: typst-community/setup-typst@v3

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      - name: Make release artifacts
        run: bin/make-release ${{ github.ref_name }}

      - name: ZIP JSON outputs
        run: zip -r json-outputs-${{ github.ref_name }}.zip json-outputs-${{ github.ref_name }}

      - name: ZIP PDF outputs
        run: zip -r pdf-outputs-${{ github.ref_name }}.zip pdf-outputs-${{ github.ref_name }}

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            json-outputs.zip
            pdf-outputs.zip

      - name: Notify coordinator of the new release
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
          PRODUCTION_SECRET: ${{ secrets.PRODUCTION_SECRET }}
          PREVIEW_URL: ${{ secrets.PREVIEW_URL }}
          PREVIEW_SECRET: ${{ secrets.PREVIEW_SECRET }}
          VERSION: ${{ github.ref_name }}
        run: |
          curl -X POST "$PRODUCTION_URL?version=$VERSION" -H "Authorization: Bearer $PRODUCTION_SECRET"
          curl -X POST "$PREVIEW_URL?version=$VERSION" -H "Authorization: Bearer $PREVIEW_SECRET"
