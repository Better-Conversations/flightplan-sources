#!/usr/bin/env ruby

require 'json'
require 'bundler/setup'
require 'open3'

FileUtils.rm_rf('json-outputs') if Dir.exist?('json-outputs')
Dir.mkdir('json-outputs')

FileUtils.rm_rf('pdf-outputs') if Dir.exist?('pdf-outputs')
Dir.mkdir('pdf-outputs')

# I don't know how entry-point discovery should work, so I'm just going to use a JSON file for now
module_files = JSON.parse!(File.read('modules.json'))

module_files.each do |module_file|
  next unless File.exist?(module_file)

  output_json_path = File.join("json-outputs", File.basename(module_file, '.rb') + '.json')
  output_pdf_path = File.join("pdf-outputs", File.basename(module_file, '.rb') + '.pdf')

  # We shell out to the CLI to keep the code isolated
  output, status = Open3.capture2e("bundle exec bcf-fp-generate . #{module_file}")

  if status.success?
    File.write(output_json_path, output)
  else
    warn "Error generating JSON for #{module_file}: #{output}"
  end

  # Generate the PDF
  `bundle exec bin/render-pdf "#{module_file}" "#{output_pdf_path}"`
end
